rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============ HELPER FUNCTIONS ============
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isSignedIn() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // ============ USERS COLLECTION ============
    
    match /users/{userId} {
      // Users can only read their own data, admins can read all
      allow read: if isSignedIn() && (isOwner(userId) || isAdmin());
      
      // Allow user creation - supports BOTH direct and referral signup
      allow create: if request.auth.uid == userId &&
                      request.resource.data.role == 'user' &&
                      request.resource.data.wallet.balance == 0 &&
                      !request.resource.data.isReferralActive &&
                      request.resource.data.referralCode is string &&
                      (request.resource.data.referredBy == null || 
                       request.resource.data.referredBy is string) &&
                      (request.resource.data.referrerId == null || 
                       request.resource.data.referrerId is string);
      
      // Users can only update safe fields
      allow update: if isOwner(userId) && 
                      !request.resource.data.diff(resource.data).affectedKeys().hasAny([
                        'role', 
                        'wallet',
                        'isReferralActive',
                        'stats',
                        'referralCode',
                        'referrerId',
                        'referredBy',
                        'createdAt'
                      ]) || isAdmin();
      
      allow delete: if false;
    }
    
    // ============ REFERRAL CODES COLLECTION ============
    
    match /referralCodes/{code} {
      // âœ… CHANGED: Allow anyone to read (for validation during registration)
      allow read: if true;
      
      // Allow users to create their OWN referral code
      allow create: if isSignedIn() && 
                      request.resource.data.userId == request.auth.uid &&
                      request.resource.data.userName is string &&
                      request.resource.data.isActive is bool;
      
      // Allow users to update their own referral code status
      allow update: if isSignedIn() && 
                      resource.data.userId == request.auth.uid &&
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isActive']);
      
      allow delete: if false;
    }
    
    // ============ ACTIVATION REQUESTS COLLECTION ============
    
    match /activationRequests/{requestId} {
      allow read: if isSignedIn() && 
                    (request.auth.uid == resource.data.userId || isAdmin());
      
      allow create: if isSignedIn() && 
                      request.resource.data.userId == request.auth.uid &&
                      request.resource.data.status == 'PENDING';
      
      allow update: if isAdmin();
      allow delete: if false;
    }
    
    // ============ TRANSACTIONS COLLECTION ============
    
    match /transactions/{transactionId} {
      allow read: if isSignedIn() && 
                    (request.auth.uid == resource.data.userId || isAdmin());
      allow create: if false;
      allow update, delete: if false;
    }
    
    // ============ WITHDRAWALS COLLECTION ============
    
    match /withdrawals/{withdrawalId} {
      allow read: if isSignedIn() && 
                    (request.auth.uid == resource.data.userId || isAdmin());
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
    
    // ============ ADMIN WITHDRAWALS COLLECTION ============
    
    match /adminWithdrawals/{withdrawalId} {
      allow read: if isAdmin();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
    
    // ============ ADMIN STATS COLLECTION ============
    
    match /adminStats/{document} {
      allow read: if isAdmin();
      allow create, update: if false;
      allow delete: if false;
    }
    
    // ============ NOTIFICATIONS COLLECTION ============
    
    match /notifications/{notificationId} {
      allow read: if isSignedIn() && 
                    request.auth.uid == resource.data.userId;
      allow create: if false;
      allow update: if isSignedIn() && 
                      request.auth.uid == resource.data.userId &&
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read', 'readAt']);
      allow delete: if false;
    }
    
    // ============ TEMP USER DATA ============
    
    match /tempUserData/{email} {
      allow read, write: if isSignedIn() && request.auth.token.email == email;
      allow delete: if false;
    }
  }
}