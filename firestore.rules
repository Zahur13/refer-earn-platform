rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============ HELPER FUNCTIONS ============
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isSignedIn() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // ============ USERS COLLECTION ============
    
    match /users/{userId} {
      // Users can only read their own data, admins can read all
      allow read: if isSignedIn() && (isOwner(userId) || isAdmin());
      
      // Allow user creation - supports BOTH direct signup and referral signup
      allow create: if request.auth.uid == userId &&
                      request.resource.data.role == 'user' &&
                      request.resource.data.wallet.balance == 0 &&
                      !request.resource.data.isReferralActive &&
                      // Referral code (required for all users)
                      request.resource.data.referralCode is string &&
                      // Referrer info (optional - null for direct signup, string for referral)
                      (request.resource.data.referredBy == null || 
                       request.resource.data.referredBy is string) &&
                      (request.resource.data.referrerId == null || 
                       request.resource.data.referrerId is string);
      
      // Users can only update safe fields (name, phone, etc.)
      allow update: if isOwner(userId) && 
                      !request.resource.data.diff(resource.data).affectedKeys().hasAny([
                        'role', 
                        'wallet',
                        'isReferralActive',
                        'stats',
                        'referralCode',
                        'referrerId',
                        'referredBy',
                        'createdAt'
                      ]) || isAdmin();
      
      allow delete: if false;
    }
    
    // ============ REFERRAL CODES COLLECTION ============
    
    match /referralCodes/{code} {
      // Anyone can read to validate codes
      allow read: if true;
      
      // Allow users to create their OWN referral code during registration
      allow create: if isSignedIn() && 
                      request.resource.data.userId == request.auth.uid;
      
      allow update, delete: if false;
    }
    
    // ============ ACTIVATION REQUESTS COLLECTION ============
    
    match /activationRequests/{requestId} {
      // Users can read their own requests, admins can read all
      allow read: if isSignedIn() && 
                    (request.auth.uid == resource.data.userId || isAdmin());
      
      // Users can create their own activation requests
      allow create: if isSignedIn() && 
                      request.resource.data.userId == request.auth.uid &&
                      request.resource.data.status == 'PENDING';
      
      // Only admins can update (approve/reject)
      allow update: if isAdmin();
      
      allow delete: if false;
    }
    
    // ============ TRANSACTIONS COLLECTION ============
    
    match /transactions/{transactionId} {
      // Users can read their own, admins can read all
      allow read: if isSignedIn() && 
                    (request.auth.uid == resource.data.userId || isAdmin());
      // Only Cloud Functions can create transactions
      allow create: if false;
      allow update, delete: if false;
    }
    
    // ============ WITHDRAWALS COLLECTION ============
    
    match /withdrawals/{withdrawalId} {
      // Users can read their own, admins can read all
      allow read: if isSignedIn() && 
                    (request.auth.uid == resource.data.userId || isAdmin());
      // Only Cloud Functions can create withdrawals
      allow create: if false;
      // Only Cloud Functions can update
      allow update: if false;
      allow delete: if false;
    }
    
    // ============ ADMIN WITHDRAWALS COLLECTION ============
    
    match /adminWithdrawals/{withdrawalId} {
      allow read: if isAdmin();
      // Only Cloud Functions can create
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
    
    // ============ ADMIN STATS COLLECTION ============
    
    match /adminStats/{document} {
      allow read: if isAdmin();
      // Only Cloud Functions can write
      allow create, update: if false;
      allow delete: if false;
    }
    
    // ============ NOTIFICATIONS COLLECTION ============
    
    match /notifications/{notificationId} {
      allow read: if isSignedIn() && 
                    request.auth.uid == resource.data.userId;
      // Only Cloud Functions can create
      allow create: if false;
      // Users can mark as read
      allow update: if isSignedIn() && 
                      request.auth.uid == resource.data.userId &&
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read', 'readAt']);
      allow delete: if false;
    }
    
    // ============ TEMP USER DATA (for registration) ============
    
    match /tempUserData/{email} {
      allow read, write: if isSignedIn() && request.auth.token.email == email;
      allow delete: if false;
    }
  }
}